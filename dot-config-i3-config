# -*- Mode: Shell-script -*-
#

# i3 config file (v4.15.1 on Xubuntu 16.04 LTS)
#
# Please see http://i3wm.org/docs/userguide.html for a complete reference!

#
# VARIABLES
#

# Helper scripts. Embedding the path explicitly is belt and braces.
set $i3apps exec --no-startup-id ~/local/bin/i3-apps
set $i3display exec --no-startup-id ~/local/bin/i3-display
set $i3keyboard exec --no-startup-id ~/local/bin/i3-keyboard
set $i3make exec --no-startup-id ~/local/bin/i3-make
set $i3mode exec --no-startup-id ~/local/bin/i3-mode
set $i3mouse exec --no-startup-id ~/local/bin/i3-mouse
set $i3wrapper exec --no-startup-id ~/local/bin/i3-wrapper
# Variables cannot reference other variables.
set $default exec --no-startup-id ~/local/bin/i3-mode default
set $dropdown exec --no-startup-id ~/local/bin/i3-wrapper dd

# These hooks are currently unused but preserved.
set $defaultnop nop
set $systemnop nop
set $layoutnop nop
set $switchnop nop
set $extrasnop nop

# Use 'xrandr' with no arguments to list monitor names and geometry.
# The values need not be mutually exclusive, but must be assigned.
set $lmon HDMI2
set $cmon HDMI1
set $rmon VGA1

# Type 'pacmd list sinks' to list audio outputs.
set $firstaudiosink alsa_output.pci-0000_00_1b.0.analog-stereo
set $secondaudiosink bluez_sink.00_01_01_00_12_CB
set $fifthaudiosink alsa_output.pci-0000_00_03.0.hdmi-stereo
# Type 'pacmd list sources' to list audio inputs.
set $firstaudiosource alsa_input.pci-0000_00_1b.0.analog-stereo
set $secondaudiosource alsa_input.usb-Alcor_Micro__Corp._TeckNet-02.analog-mono
set $thirdaudiosource alsa_input.usb-C-Media_Electronics_Inc._USB_Audio_Device-00-Device.analog-mono

# The font used in i3-input prompt+command boxes.
# Forward declaration because used in various bindings.
set $i3inputfont "pango:DejaVu Sans 12"

#
# BINDINGS 1 (reserved, recommended)
#

# Mod4 is the Windows key. Mod1 is the Alt key.
# Menu can be generated by a modifier key using 'xcape'.

# The standard entry point to my modes: Layout, Switch, Tab.
# Menu is deliberate do not change.
# I have used 'xcape' to bind Super_L to Menu for the left hand.
bindsym Menu $i3mode Layout

# Run i3-make.
#
# This installs the configuration into its runtime locations,
# and as required, reloads this config or restarts i3.
bindsym Control+Tab $i3make

# The lines to the right of the ### comments illustrate the body of an
# example i3-make script.
#
### I3FILES=$(readlink -f ~/Programs/i3files)
### cd ${I3FILES}
### make \
###     CONFIGURED=true I3BIN="${HOME}/local/bin" \
###     -f ${I3FILES}/Makefile -C ${I3FILES} "$@"

# Command prompt.
bindsym Mod4+Tab  $i3wrapper -p

# Scratchpad terminal.
bindsym Control+Delete $dropdown

# System mode is for emergency use only.
# Control-Alt-Delete is deliberate do not change.
bindsym Control+Mod1+Delete $i3mode System

# This lets us move and resize without having to position the mouse
# with precision on window edges.
floating_modifier Mod4

#
# BINDINGS 2 Numpad "immediate".
#

# Mute the default preferred microphone with the large key.
# Subject to change:
# - source 2 TeckNet microphone.
bindsym KP_Insert \
    exec pactl set-source-mute $secondaudiosource on  # mute
bindsym KP_Delete \
    exec pactl set-source-mute $secondaudiosource off  # unmute

# Volume controls for inputs (sources) and outputs (sinks).
# Subject to change:
# - sink 1 3.5mm rear line out,
# - sink 2 Bluetooth (headphones),
bindsym KP_Divide \
    exec pactl set-sink-volume $secondaudiosink -10%
bindsym KP_Multiply \
    exec pactl set-sink-volume $secondaudiosink +10%
bindsym KP_Subtract \
    exec pactl  set-sink-volume $firstaudiosink 100%
bindsym KP_Add \
    exec pactl set-sink-volume $firstaudiosink +10%
bindsym KP_Enter \
    exec pactl set-sink-volume $firstaudiosink -10%

#
# MODES
#

# System mode.
# Bind Control+<letter> keys only.
# It must be possible to have limited use of 'vi' from within this mode.
mode "System" {

   # Get back to default mode.
    bindsym Control+q $default
    bindsym Control+d mode "default"

    # The minimum required to get to a terminal.
    bindsym Control+w restart
    bindsym Control+r reload
    bindsym Control+t exec --no-startup-id xfce4-terminal -T xfce4-terminal  &
    bindsym Control+p exec --no-startup-id xfce4-panel --restart &

    # Restart file (g) and focus (f) watchers.
    bindsym Control+f $i3wrapper -f
    bindsym Control+g $i3wrapper -g

    # Untried but here just in case.
    bindsym Control+b shmlog $((64*1024*1024))
    bindsym Control+n shmlog toggle
    bindsym Control+m debuglog toggle
}

# Layout mode.
mode "Layout" {

    # Toggle between workspaces.
    bindsym q $default, workspace back_and_forth

    # Change focus.
    bindsym w focus up
    bindsym a focus left
    bindsym s focus down
    bindsym d focus right

    # Move focused window.
    bindsym t move up
    bindsym f move left
    bindsym g move down
    bindsym h move right

    # Increase or decrease the height or width symmetrically.
    bindsym i resize grow up 6 px or 1 ppt, resize grow down 6 px or 1 ppt
    bindsym j resize shrink left 6 px or 1 ppt, resize shrink right 6 px or 1 ppt
    bindsym k resize shrink down 6 px or 1 ppt, resize shrink up 6 px or 1 ppt
    bindsym l resize grow right 6 px or 1 ppt, resize grow left 6 px or 1 ppt

    bindsym e $layoutnop
    bindsym r $layoutnop

    bindsym y $layoutnop
    bindsym u $layoutnop

    # Focus the child container.
    bindsym o focus child
    # Focus the parent container.
    bindsym p focus parent

    # Standard terminal, preceded by a split.
    bindsym bracketleft $layoutnop
    bindsym bracketright $layoutnop

    # Toggle between being a tiled|floating window.
    # Toggle focus between tiled|floating windows.
    bindsym semicolon floating toggle
    bindsym apostrophe focus mode_toggle

    # Command prompt.
    bindsym backslash $default, $i3wrapper -p

    # Layouts.
    bindsym z layout default
    bindsym c layout tabbed

    # Split vertically next time.
    bindsym v split vertical
    # Split horizontally next time.
    bindsym b split horizontal

    # Swap (eXchange) containers.
    bindsym x \
        $default, exec i3-input -f $i3inputfont  \
        -P '(swap container with mark): ' -F 'swap container with mark "%s"'

   # reName a workspace.
    bindsym n \
        $default, exec i3-input -f $i3inputfont  \
        -P '(rename this workspace to): ' \
        -F 'rename workspace to "%s"'

    # Set or clear the window Mark.
    # Avoid marks that match command aliases.
    # System alias: [A-Z][A-Z] User alias; [a-z][a-z].
    # Marks are not limited to length two (here), but by i3input.
    bindsym m \
        $default, exec i3-input -f $i3inputfont  \
        -P '(toggle mark): ' -F 'mark --toggle "%s"'

    # Switch to (named) workspace.
    bindsym comma  \
        $default, exec i3-input -f $i3inputfont  \
        -P '(switch focus to workspace): ' \
        -F 'workspace "%s"'
    # Move to (named) workspace.
    bindsym period \
       $default, exec i3-input -f $i3inputfont  \
        -P '(move container to workspace): ' \
        -F 'move container to workspace "%s"'

    # DMenu.
    bindsym slash $default, $i3wrapper -d

    # Tab mode.
    bindsym Tab mode "Tab"
    bindsym Return mode "Tab"

    # Go to Switch mode.
    bindsym Menu mode "Switch"
    # Go back to normal.
    bindsym space $default
}

# Switch mode.
# Entered from Layout mode.
mode "Switch" {

    # Move workspace to a specific monitor.
    bindsym q $default, move workspace to output $lmon
    bindsym w $default, move workspace to output $cmon
    bindsym e $default, move workspace to output $rmon

    # Displays ON. This causes monitors to switch back to DVI.
    bindsym r $default, exec xrandr --output $lmon --auto --left-of $cmon &
    bindsym t $default, exec xrandr --output $cmon --auto &
    bindsym y $default, exec xrandr --output $rmon --auto --right-of $cmon &

   # Switch to workspace with urgency hints.
    bindsym u $default, [urgent=latest] focus

    # Displays OFF. This allows monitors to switch to HDMI.
    bindsym i $default, exec xrandr --output $lmon --off &
    bindsym o $default, exec xrandr --output $cmon --off &
    bindsym p $default, pexec xrandr --output $rmon --off &

    bindsym bracketleft $switchnop
    bindsym bracketright $switchnop

    # Move container to a specific monitor.
    bindsym a $default, move container to output $lmon
    bindsym s $default, move container to output $cmon
    bindsym d $default, move container to output $rmon

    # Enter fullscreen mode for the focused container.
    bindsym f $default, fullscreen toggle
    bindsym g $default, fullscreen toggle

    bindsym h $switchnop
    bindsym j $switchnop
    bindsym k $switchnop
    bindsym l $switchnop

    bindsym semicolon $switchnop
    bindsym apostrophe $switchnop

    # Command prompt.
    bindsym backslash $default, $i3wrapper -p

    # Switch focus to a specific monitor.
    bindsym z $default, focus output $lmon
    bindsym x $default, focus output $cmon
    bindsym c $default, focus output $rmon

    # Toggle an adjacent horizontal pair to Vertical. Left has focus, Upper gets focus.
    bindsym v focus right, split v, focus left, move right, move up ;
    # Toggle an adjacent vertical pair to Horizontal. Upper has focus, Left gets focus.
    bindsym b focus down, split h, focus up, move down, move left;

    bindsym n $switchnop
    bindsym m $switchnop

    bindsym comma $switchnop
    bindsym period $switchnop
    bindsym slash $switchnop

    # Tab mode.
    bindsym Tab mode "Tab"
    bindsym Return mode "Tab"

    # Go to default mode.
    # Going directly to Layout mode doesn't work here ... ???
    bindsym Menu $default

    # Go back to normal.
    bindsym space $default
}

# Tab Mode.
# Entered from switch or layout mode using Tab (or Return).
# Originally created for the 'kill' binding only. Keep it sparse.
mode "Tab" {

    # Kill window. using the wrapper's 'kill' option to prevent
    # killing critical windows by mistake.
    bindsym Control+q $default, \
            $i3wrapper -k \
            emacs

    # Keyboard & Mouse. Display & Desktop.
    # Bindings are vaguely mnemonic.

    bindsym q $extrasnop
    bindsym w $default, $i3display wake
    bindsym e $default, $i3mouse enable
    bindsym r $extrasnop
    bindsym t $extrasnop
    bindsym y $extrasnop
    bindsym u $extrasnop
    bindsym i $default, $i3apps start bgapps
    bindsym o $default, $i3apps stop fgapps bgapps
    bindsym p $extrasnop

    bindsym a $extrasnop
    bindsym s $default, $i3display sleep
    bindsym d $default, $i3mouse disable
    bindsym f $extrasnop
    bindsym g $extrasnop
    bindsym h $extrasnop
    bindsym j $extrasnop
    bindsym k $default, $i3keyboard
    bindsym l $extrasnop

    bindsym z $extrasnop
    bindsym x $extrasnop
    bindsym c $extrasnop
    bindsym v $extrasnop
    bindsym b $extrasnop
    bindsym m $extrasnop
    bindsym n $default, exec --no-startup-id nitrogen --restore

    bindsym comma $extrasnop
    bindsym period $extrasnop
    bindsym slash $extrasnop

    bindsym Tab $default
    bindsym Return $default

    # Go back to normal.
    bindsym space $default
}

#
# SETTINGS
#

# Support toggling between workspaces.
workspace_auto_back_and_forth yes

# Assign workspaces to outputs.
workspace "wm" output $lmon
workspace "tv" output $lmon
workspace "mp" output $lmon
workspace "fp" output $lmon

# Assign applications to workspaces.
assign [instance="xfce4-terminal" title="watcher$"] wm
assign [instance="xfce4-terminal" title="tvheadend"] tv
assign [instance="gl" class="mpv"]  mp
assign [class="ffplay"] fp

# Windows that look'n'feel better when floating.
for_window [instance="dtvkit"] floating enable;
for_window [instance="xfce4-notifyd$"] floating enable;
for_window [instance="yad"] floating enable;
for_window [title="Bluetooth Devices"] floating enable;
for_window [title="Do Not Panic"] floating enable;
for_window [title="File Operation Progress"] floating enable;
for_window [title="KeyClick"] floating enable;
for_window [title="Scratchpad"] floating enable;
for_window [title="Unlock Keyring"] floating enable;

# Mark with a two digit number and change workspace.
for_window [instance="emacs"] $i3wrapper i3em;
for_window [class="Google-chrome"] $i3wrapper i3gc;

# VirtualBox windows assume full screen dimensions.
for_window [title="VirtualBox Manager"] layout tabbed;

# Colours for windows.
# Defaults changed to green title bar and border when focused.
# class | border | background | text | indicator | child_border
client.focused          #4c7899 #185522 #ffffff #2e9ef4   #185522
client.focused_inactive #333333 #5f676a #ffffff #484e50   #5f676a
client.unfocused        #333333 #222222 #888888 #292d2e   #222222
client.urgent           #2f343a #900000 #ffffff #900000   #900000
client.placeholder      #000000 #0c0c0c #ffffff #000000   #0c0c0c

# Font for window titles. The font for the bar is set explicitly.
font pango:DejaVu Sans 8

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
    i3bar_command /usr/bin/i3bar
    status_command /usr/bin/i3status --config ~/.config/i3status/config
    tray_output $cmon
    font pango:DejaVu Sans 10
    bindsym button2 $default, [urgent=latest] focus
    bindsym button3 workspace back_and_forth
}

# Mouse behaviour wrt windows.
focus_follows_mouse no

# Additional Menu and Escape keys. US layout on UK PC105. 'keycode
# 51' is mapped to Return to mimic the geometry of the US keyboard.
# Stuck modiiers are cleared.
$i3keyboard

# Put the "i3-nagbar" on the primary monitor.
exec --no-startup-id xrandr --output $cmon --primary &

# Compton. As per manpage requires (~/.config/compton.conf).
# Desktop background (for empty workspaces).
# https://faq.i3wm.org/question/6/how-can-i-set-a-desktop-background-image-in-i3/
# The 10 second delay between starting compton and applying the
# desktop background avoids screen corruption on my machine.
exec --no-startup-id compton -b &
exec --no-startup-id sleep 10s && nitrogen --restore &

# Applications.
# The 10 second delay ensures that the dialog appears after the
# desktop background changes.
exec --no-startup-id sleep 10s && ~/local/bin/i3-apps start bgapps

#
# Done
#
